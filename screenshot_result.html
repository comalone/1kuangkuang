<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆªå›¾ç»“æœ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #000;
        }

        #screenshotImage {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 300px;
            height: auto;
            max-height: 225px;
            object-fit: cover;
            z-index: 20;
            border-radius: 12px;
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .no-screenshot {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 2;
        }

        .no-screenshot-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        #aiAnalysisPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 60px;
            z-index: 5;
            text-align: center;
            overflow-y: auto;
        }

        #aiAnalysisPanel h3 {
            color: #fff;
            font-size: 2.2em;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-content-wrapper {
            max-width: 900px;
            width: 100%;
        }

        #aiResponseText {
            color: #eee;
            line-height: 1.8;
            font-size: 1em;
            text-align: left;
        }

        #aiResponseText h3 {
            color: #667eea;
            margin: 25px 0 15px 0;
            font-size: 1.4em;
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            padding-bottom: 5px;
        }

        #aiResponseText p {
            margin-bottom: 15px;
        }

        #aiResponseText ul,
        #aiResponseText ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }

        #aiResponseText li {
            margin-bottom: 8px;
        }

        #aiResponseText strong {
            color: #ffadad;
        }

        .cursor {
            display: inline-block;
            width: 4px;
            height: 1.2em;
            background-color: #667eea;
            margin-left: 8px;
            vertical-align: middle;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {

            from,
            to {
                background-color: transparent;
            }

            50% {
                background-color: #667eea;
            }
        }

        .success-message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
            padding: 10px 25px;
            border-radius: 30px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
            color: #667eea !important;
            font-style: italic;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .mini-video-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 240px;
            aspect-ratio: 4/3;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.9);
            z-index: 1000;
        }

        #miniVideoFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .mini-video-hint {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(102, 126, 234, 0.8);
            color: white;
            font-size: 0.85em;
            padding: 4px 0;
            text-align: center;
            font-weight: bold;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="successMessage" class="success-message" style="display: none;">
        æˆªå›¾æˆåŠŸ~
    </div>

    <img id="screenshotImage" style="display: none;" alt="æˆªå›¾ç»“æœ">

    <div id="noScreenshot" class="no-screenshot" style="display: none;">
        <div class="no-screenshot-icon">ğŸ“·</div>
        <div class="no-screenshot-text">æš‚æ— æˆªå›¾</div>
        <p style="color: #ccc;">è¯·å…ˆå®Œæˆæˆªå›¾æ“ä½œ</p>
    </div>

    <div id="aiAnalysisPanel" style="display: none;" class="fade-in">
        <h3><span>ğŸ¤–</span> AIå°åŠ©ç†ï¼š</h3>
        <div class="ai-content-wrapper" style="position: relative;">
            <div id="aiResponseText" class="loading">æ­£åœ¨åˆ†æä¸­...</div>
            <span id="cursor" class="cursor" style="display:none;"></span>
        </div>
    </div>

    <div class="mini-video-container">
        <img id="miniVideoFeed" src="/video_feed" alt="å®æ—¶ç”»é¢">
        <div class="mini-video-hint">ğŸ‘Œ OKæ‰‹åŠ¿è¿”å›æ‹æ‘„</div>
    </div>

    <script>
        marked.setOptions({ breaks: true });

        function typeWriter(text, element, speed = 10) {
            const cursor = document.getElementById('cursor');
            if (cursor) cursor.style.display = 'inline-block';
            element.innerHTML = "";
            let i = 0;
            let currentText = "";
            function type() {
                if (i < text.length) {
                    currentText += text.charAt(i);
                    element.innerHTML = marked.parse(currentText);
                    i++;
                    setTimeout(type, speed);
                } else {
                    if (cursor) cursor.style.display = 'none';
                }
            }
            type();
        }

        async function loadScreenshot() {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æˆªå›¾
                const statusResponse = await fetch('/screenshot_status');
                const statusData = await statusResponse.json();

                if (statusData.has_screenshot) {
                    // åŠ è½½æˆªå›¾
                    const img = document.getElementById('screenshotImage');
                    img.src = '/get_screenshot?t=' + new Date().getTime();
                    img.style.display = 'block';

                    document.getElementById('noScreenshot').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';

                    // å¼€å§‹åŠ è½½ AI åˆ†æç»“æœ
                    loadAIResponse();
                } else {
                    // æ²¡æœ‰æˆªå›¾
                    document.getElementById('screenshotImage').style.display = 'none';
                    document.getElementById('noScreenshot').style.display = 'block';
                    document.getElementById('successMessage').style.display = 'none';
                }
            } catch (error) {
                console.error('åŠ è½½æˆªå›¾å¤±è´¥:', error);
                alert('åŠ è½½æˆªå›¾å¤±è´¥,è¯·é‡è¯•');
            }
        }

        async function loadAIResponse() {
            const aiPanel = document.getElementById('aiAnalysisPanel');
            const aiText = document.getElementById('aiResponseText');

            aiPanel.style.display = 'block';

            const fetchAI = async () => {
                try {
                    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const response = await fetch('/get_ai_response?t=' + new Date().getTime());
                    const data = await response.json();

                    if (data.analysis) {
                        // å¦‚æœåˆ†æå®Œæˆæˆ–å‡ºé”™ï¼Œåœæ­¢è½®è¯¢å¹¶æ›´æ–°æ ·å¼
                        if (data.analysis !== "æ­£åœ¨åˆ†æä¸­...") {
                            aiText.classList.remove('loading');
                            if (data.analysis.includes("å¤±è´¥") || data.analysis.includes("å‡ºé”™")) {
                                aiText.style.color = "#f5576c"; // é”™è¯¯çº¢è‰²
                                aiText.textContent = data.analysis;
                            } else {
                                aiText.style.color = "#fff"; // æ­£å¸¸é¢œè‰²
                                typeWriter(data.analysis, aiText);
                            }
                            return true;
                        } else {
                            aiText.textContent = data.analysis;
                        }
                    }
                } catch (error) {
                    console.error('è·å–AIå“åº”å¤±è´¥:', error);
                }
                return false;
            };

            // æ¯2ç§’è½®è¯¢ä¸€æ¬¡ï¼Œç›´åˆ°è·å–åˆ°ç»“æœ
            const poll = async () => {
                const finished = await fetchAI();
                if (!finished) {
                    setTimeout(poll, 2000);
                }
            };

            poll();
        }

        let isResetting = false;
        async function newScreenshot() {
            if (isResetting) return;
            isResetting = true;

            try {
                // è°ƒç”¨åç«¯é‡ç½®çŠ¶æ€æ¥å£
                const response = await fetch('/reset_screenshot', { method: 'POST' });
                if (response.ok) {
                    // é‡ç½®æˆåŠŸåè·³è½¬å›æ‹æ‘„é¡µé¢
                    window.location.href = '/screenshot.html';
                } else {
                    alert('é‡ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥,è¯·é‡è¯•');
                isResetting = false;
            }
        }

        // è½®è¯¢æ‰‹åŠ¿ä»¥è§¦å‘é‡ç½®
        async function checkGestureForReset() {
            if (isResetting) return;
            try {
                const response = await fetch('/screenshot_status');
                const data = await response.json();
                if (data.gesture === 'ok') {
                    console.log('æ£€æµ‹åˆ° OK æ‰‹åŠ¿ï¼Œæ­£åœ¨é‡ç½®...');
                    newScreenshot();
                }
            } catch (error) {
                console.error('è·å–æ‰‹åŠ¿å¤±è´¥:', error);
            }
        }

        // å®æ—¶ç”»é¢åˆ·æ–°é€»è¾‘
        let lastVideoUpdate = 0;
        const VIDEO_UPDATE_INTERVAL = 200;

        function refreshMiniVideo() {
            const now = Date.now();
            if (now - lastVideoUpdate < VIDEO_UPDATE_INTERVAL) return;
            lastVideoUpdate = now;

            const img = document.getElementById('miniVideoFeed');
            const newSrc = '/video_feed?t=' + now;

            const tempImg = new Image();
            tempImg.onload = () => img.src = newSrc;
            tempImg.src = newSrc;
        }

        function animateMiniVideo() {
            refreshMiniVideo();
            requestAnimationFrame(animateMiniVideo);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œåˆå§‹åŒ–
        window.onload = () => {
            loadScreenshot();
            animateMiniVideo();
            setInterval(checkGestureForReset, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡æ‰‹åŠ¿
        };
    </script>
</body>

</html>